###############################################
# ModSecurity Configuration for WordPress
###############################################

# ðŸ”¥ Habilitar ModSecurity
SecStatusEngine Off
SecRuleEngine On

# ðŸš¨ Registro de eventos de seguridad
SecAuditEngine RelevantOnly
SecAuditLog /var/log/apache2/modsec_audit.log
SecAuditLogParts ABCDEFHIJK

# ðŸ”¥ Permitir directamente archivos estÃ¡ticos y fuentes sin validaciÃ³n adicional
SecRule REQUEST_URI "\.(js|css|woff|woff2|ttf|svg|jpg|png|gif|webp|ico|map|json)$" \
    "id:5001, phase:1, allow, msg:'Permitir archivos estÃ¡ticos en WordPress'"

# âœ… Permitir wp-includes sin que pase por validaciones de seguridad
SecRule REQUEST_URI "^/wp-includes/(js|css|blocks|dist|fonts)/" \
    "id:5008, phase:1, allow, nolog, msg:'Permitir archivos en wp-includes/'"

# âœ… Permitir fuentes de WordPress sin validaciÃ³n
SecRule REQUEST_URI "@pm .ttf .woff .woff2 .eot .svg .otf .gif .png .jpg .webp" \
    "id:5009, phase:1, allow, nolog, msg:'Permitir fuentes e imÃ¡genes en WordPress'"    

# âœ… Permitir acceso completo a `wp-admin/` sin validaciones
SecRule REQUEST_URI "^/wp-admin/.*$" \
    "id:5015, phase:1, allow, nolog, msg:'Permitir acceso a wp-admin'"

# âœ… Permitir `admin-ajax.php`
SecRule REQUEST_URI "@streq /wp-admin/admin-ajax.php" \
    "id:5010, phase:1, allow, nolog, msg:'Permitir admin-ajax.php en WordPress'"

# ðŸš€ Permitir carga de fuentes remotas
SecRule REQUEST_HEADERS:Referer "@rx ^https?://(fonts\.googleapis\.com|cdnjs\.cloudflare\.com|cdn\.jsdelivr\.net|fonts\.bunny\.net|secure\.gravatar\.com)" \
    "id:5020, phase:1, allow, log, msg:'Permitir fuentes y CSS desde servicios externos'"

# ðŸ”¥ Ajustes avanzados para WordPress
# âœ… Evitar bloqueos en formularios de WordPress
SecRuleRemoveById 1003
SecRuleRemoveById 1004
SecRuleRemoveById 1005
SecRuleRemoveById 949110
SecRuleRemoveById 949100

# ðŸš€ Permitir JSON y API REST de WordPress
SecRule REQUEST_URI "^/wp-json/" \
    "id:5025, phase:1, allow, log, msg:'Permitir API REST de WordPress'"

# ðŸš¨ ProtecciÃ³n contra ataques comunes
# Bloquear SQL Injection bÃ¡sico
SecRule ARGS "@rx (union.*select.*from|select.*from.*where|insert.*into.*values|update.*set.*where|delete.*from.*where)" \
    "id:6001, phase:2, deny, log, msg:'Intento de SQL Injection detectado'"

# Bloquear XSS bÃ¡sico
SecRule ARGS "@rx (<script|javascript:|onerror|onload|alert\()" \
    "id:6002, phase:2, deny, log, msg:'Intento de XSS detectado'"

# ðŸš€ ProtecciÃ³n contra bots
SecRule REQUEST_HEADERS:User-Agent "@rx (python|curl|wget|httpclient|java|perl)" \
    "id:6003, phase:1, deny, log, msg:'Bloqueo de bots sospechosos'"

# ðŸ”¥ ConfiguraciÃ³n de anÃ¡lisis de trÃ¡fico
SecDebugLog /var/log/apache2/modsec_debug.log
SecDebugLogLevel 3

